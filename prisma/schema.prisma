generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

// Users
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  
  conversations Conversation[]
  sessions      Session[]
}

// Conversations
model Conversation {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  messages Message[]
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  role           String       // 'user' or 'assistant'
  content        String
  timestamp      DateTime     @default(now())
}

// Sessions
model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  expiresAt DateTime
  data      Json?
}

// Knowledge Base (with pgvector)
model KnowledgeBase {
  id        String   @id @default(uuid())
  content   String
  embedding Unsupported("vector(1536)")
  metadata  Json?
  createdAt DateTime @default(now())
  
  @@index([embedding(ops: raw("vector_cosine_ops"))], type: Hnsw)
}

// Agent Health
model AgentHealth {
  id          String   @id @default(uuid())
  agentType   String
  status      String   // 'healthy', 'degraded', 'down'
  lastCheck   DateTime @default(now())
  errorCount  Int      @default(0)
  metadata    Json?
}

// Audit Log
model AuditLog {
  id        String   @id @default(uuid())
  agentId   String?
  userId    String?
  action    String
  input     Json?
  output    Json?
  status    String
  error     String?
  metadata  Json?
  timestamp DateTime @default(now())
}
