generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  extensions = [pgvector(map: "vector")]
}

// Users
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  
  conversations Conversation[]
  sessions      Session[]
}

// Conversations
model Conversation {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  messages Message[]
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  role           String       // 'user' or 'assistant'
  content        String
  timestamp      DateTime     @default(now())
}

// Sessions
model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  expiresAt DateTime
  data      Json?
}

// Knowledge Base (with pgvector)
model KnowledgeBase {
  id        String   @id @default(uuid())
  content   String
  embedding Unsupported("vector(1536)")
  metadata  Json?
  createdAt DateTime @default(now())
  
  @@index([embedding(ops: raw("vector_cosine_ops"))])
}

// Agent Health
model AgentHealth {
  id          String   @id @default(uuid())
  agentType   String
  status      String   // 'healthy', 'degraded', 'down'
  lastCheck   DateTime @default(now())
  errorCount  Int      @default(0)
  metadata    Json?
}

// Audit Log
model AuditLog {
  id        String   @id @default(uuid())
  agentId   String?
  userId    String?
  action    String
  input     Json?
  output    Json?
  status    String
  error     String?
  metadata  Json?
  timestamp DateTime @default(now())
}

// Personal Finance (Batch 2)
model Transaction {
  id          String   @id @default(uuid())
  userId      String
  amount      Float
  description String
  category    String
  date        DateTime
  createdAt   DateTime @default(now())
  
  @@index([userId, date])
  @@index([category])
}

model Budget {
  id        String   @id @default(uuid())
  userId    String
  category  String
  amount    Float
  period    String   // 'monthly', 'weekly', 'yearly'
  spent     Float    @default(0)
  createdAt DateTime @default(now())
  
  @@unique([userId, category, period])
}

model SavingsGoal {
  id            String   @id @default(uuid())
  userId        String
  name          String
  targetAmount  Float
  currentAmount Float    @default(0)
  targetDate    DateTime
  priority      String   // 'low', 'medium', 'high'
  status        String   @default("active") // 'active', 'completed', 'cancelled'
  createdAt     DateTime @default(now())
  
  @@index([userId, status])
}

model Alert {
  id        String   @id @default(uuid())
  userId    String
  type      String   // 'budget', 'savings', 'transaction', 'milestone'
  severity  String   // 'info', 'warning', 'critical'
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([userId, read])
  @@index([createdAt])
}

model PrivacySettings {
  id                String   @id @default(uuid())
  userId            String   @unique
  dataRetentionDays Int      @default(365)
  allowAnalytics    Boolean  @default(true)
  encryptionEnabled Boolean  @default(true)
  updatedAt         DateTime @updatedAt
}

model DestructiveAction {
  id          String   @id @default(uuid())
  userId      String
  agentType   String
  action      String
  description String
  approved    Boolean  @default(false)
  executedAt  DateTime?
  createdAt   DateTime @default(now())
  
  @@index([userId, approved])
}
